<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Word Circle Game</title>

  <!-- Single stylesheet used by all challenges -->
  <link id="challengeStylesheet" rel="stylesheet" href="styles.css">

  <!-- jsPDF for results export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- FOUC guard -->
  <style>
    html:not(.styles-ready) body {
      visibility: hidden;
    }

    html:not(.styles-ready) #loadingScreen {
      visibility: visible;
      display: flex !important;
    }

    #loadingScreen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      z-index: 10000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .loading-content {
      text-align: center;
      color: #d33;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(227, 6, 19, .25);
      border-top: 4px solid #E30613;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <script>
    // unhide once the stylesheet loads
    (function () {
      const link = document.getElementById('challengeStylesheet');
      if (link) link.addEventListener('load', () => document.documentElement.classList.add('styles-ready'));
      // safety hatch in case onload is missed (e.g. cached)
      window.addEventListener('DOMContentLoaded', () => {
        if (!link || link.sheet) document.documentElement.classList.add('styles-ready');
      });
    })();
  </script>
</head>

<body>
  <!-- 3-2-1 countdown -->
  <div id="countdownOverlay" style="display:none;">
    <div id="countdownNumber">3</div>
  </div>

  <!-- Optional admin (hidden) -->
  <div id="adminPanel" style="display:none; margin:16px 0;"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen" style="display:flex;">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>Loading Game...</h3>
    </div>
  </div>

  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="welcome-screen" style="display:none;">
    <div class="welcome-container">
      <div class="welcome-header">
        <div class="welcome-logo" id="welcomeLogo"></div>
        <h1 class="welcome-title" id="gameTitle"></h1>
        <p class="welcome-subtitle" id="gameSubtitle"></p>
      </div>

      <div class="welcome-content">
        <div class="game-rules">
          <h3>üéØ How to Play</h3>

          <div class="rules-grid">
            <div class="rule-item">
              <h4>üèÜ The Challenge</h4>
              <p>Answer business-related questions for each letter A‚ÄìZ. Each letter has a specific definition to
                complete.</p>
            </div>
            <div class="rule-item">
              <h4>‚è∞ Time Pressure</h4>
              <p>You have <span id="welcomeTimeLimit"></span> to complete all 26 questions. Quick thinking and business
                knowledge are key!</p>
            </div>
            <div class="rule-item">
              <h4>üéÆ Controls</h4>
              <p><strong>Answer:</strong> Type and press Enter<br><strong>Pass:</strong> Skip to next
                question<br><strong>Hint:</strong> First letter + length (<span id="welcomeMaxHints"></span> max)</p>
            </div>
            <div class="rule-item">
              <h4>üß† Smart Matching</h4>
              <p>The system accepts similar answers and provides helpful hints when you're close.</p>
            </div>
          </div>

          <div class="scoring-table">
            <h4>üìä Scoring System</h4>
            <div class="scoring-row"><span>Correct Answer</span><span id="correctPoints" class="correct-score"></span>
            </div>
            <div class="scoring-row"><span>Incorrect Answer</span><span id="incorrectPoints"
                class="incorrect-score"></span></div>
            <div class="scoring-row"><span>Pass (Skip)</span><span id="pasapalabraPoints" class="warning-score"></span>
            </div>
            <div class="scoring-row">
              <span>Time Bonus (<span id="timeBonusThreshold"></span>+ correct)</span>
              <span id="maxTimeBonus" class="correct-score"></span>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="warning" onclick="startPreview()">üëÅÔ∏è Preview Questions</button>
          <button onclick="startGame()">üöÄ Start Challenge</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Container -->
  <div id="gameContainer" class="game-container" style="display:none;">
    <header class="compact-header">
      <div class="header-top">
        <button class="back-home" type="button" title="Back to home" onclick="game.backToWelcome()">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>
        <h1 id="gameHeaderTitle"></h1>
        <span class="header-spacer" aria-hidden="true"></span>
      </div>

      <div class="header-stats">
        <div class="stat mini"><span>CORRECT</span><strong id="correctCount">0</strong></div>
        <div class="stat mini"><span>WRONG</span><strong id="incorrectCount">0</strong></div>
        <div class="stat mini"><span>POINTS</span><strong id="pointsCount">0</strong></div>
        <div class="stat mini"><span>HINTS</span><strong class="hints-left">0</strong></div>
        <div id="timer" class="timer-mini">00:00</div>
      </div>
    </header>

    <!-- Rosco -->
    <div class="rosco-container">
      <div class="rosco" id="rosco"></div>
      <div class="current-letter" id="currentLetterDisplay"></div>
      <div class="center-image">
        <div id="centerLogo"></div>
      </div>
    </div>

    <!-- Sticky action bar with question + input + buttons -->
    <!-- Sticky action bar with question + input + buttons (all together) -->
    <div id="actionBar" class="actionbar">
      <div id="hintToast" class="hint-toast" aria-live="polite"></div>

      <div class="game-info in-bar">
        <div class="question-row">
          <p id="definition">Loading game...</p>
          <button id="hintIcon" class="hint-icon" onclick="game.showHint()" title="Hint" aria-label="Hint">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M9 18h6m-5 2h4M12 2a7 7 0 00-4 12v2h8v-2A7 7 0 0012 2z" fill="none" stroke="currentColor"
                stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>
        <div id="fuzzyHint" class="fuzzy-hint" style="display:none;">
          ü§î Close! Try a similar word or check your spelling.
        </div>
      </div>

      <div class="input-container">
        <input type="text" id="answer" placeholder="Type your answer here..." autocomplete="off">
      </div>

      <div class="btn-row">
        <button id="btnSubmit" class="with-ico" onclick="game.checkAnswer()">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z" />
          </svg>
          SUBMIT
        </button>
        <button id="btnPass" class="btn-pass with-ico" onclick="game.pasapalabra()">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M8 5v14l11-7zM5 5h2v14H5z" />
          </svg>
          PASS
        </button>
      </div>
    </div>

    <div id="finalScore"></div>

    <div style="text-align:center; margin-top: 12px;">
      <button id="viewResults" onclick="game.showResults()" style="display:none;">üìä View detailed results</button>
    </div>

    <div id="results" style="display:none;"></div>
  </div>

  <!-- Scripts -->
  <script src="gameUtils.js"></script>
  <script src="wordCircleGame.js"></script>
  <script>
    function runCountdown(cb) {
      const o = document.getElementById('countdownOverlay');
      const n = document.getElementById('countdownNumber');
      let v = 3; n.textContent = v; o.classList.add('show');
      const t = setInterval(() => {
        v--;
        if (v <= 0) { clearInterval(t); o.classList.remove('show'); cb(); }
        else { n.textContent = v; }
      }, 1000);
    }

    function updateModePill(isPreview) {
      const pill = document.getElementById('modePill');
      if (pill) pill.hidden = !isPreview;
    }

    function startGame() {
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      document.querySelector('#actionBar #definition').textContent = 'Loading game‚Ä¶'; 
      updateModePill(false);
      runCountdown(() => game.newGame());
    }

    function startPreview() {
      document.body.classList.add('preview-mode');
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      document.querySelector('#actionBar #definition').textContent = 'Loading game‚Ä¶';
      updateModePill(true);
      runCountdown(() => game.startPreview());
    }

    (function wrapBackToWelcome() {
      const original = WordCircleGame && WordCircleGame.prototype.backToWelcome;
      if (typeof original === 'function') {
        WordCircleGame.prototype.backToWelcome = function () {
          original.call(this);
          updateModePill(false);
        };
      }
    })();

    window.addEventListener('load', async () => {
      try {
        await game.init();
        setTimeout(() => {
          const startBtn = document.querySelector('button[onclick="startGame()"]');
          if (startBtn) startBtn.focus();
        }, 100);
      } catch (err) {
        console.error('Failed to initialize game:', err);
        document.getElementById('loadingScreen').innerHTML =
          '<div class="loading-content"><h3 style="color: red;">Error loading game. Please check console.</h3></div>';
      }
    });
  </script>

  <script>
    // ‚Äî‚Äî‚Äî zoom lock helper ‚Äî‚Äî‚Äî
    (function () {
      const vp = document.querySelector('meta[name="viewport"]');
      const DEFAULT = 'width=device-width, initial-scale=1.0';
      const LOCKED = DEFAULT + ', maximum-scale=1, user-scalable=no';
      function setViewport(lock) { if (vp) vp.setAttribute('content', lock ? LOCKED : DEFAULT); }
      window.__lockZoom = setViewport;

      // Prevent iOS "double-tap to zoom"
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) { e.preventDefault(); }
        lastTouchEnd = now;
      }, { passive: false });
    })();

    // Lock while playing / previewing; restore on home
    (function patchGameZoom() {
      const proto = WordCircleGame && WordCircleGame.prototype;
      if (!proto) return;

      const _startPreview = proto.startPreview;
      proto.startPreview = function () {
        window.__lockZoom?.(true);
        return _startPreview.call(this);
      };

      const _newGame = proto.newGame;
      proto.newGame = function () {
        window.__lockZoom?.(true);
        return _newGame.call(this);
      };

      const _back = proto.backToWelcome;
      proto.backToWelcome = function () {
        const r = _back.call(this);
        window.__lockZoom?.(false);
        return r;
      };
    })();
  </script>
</body>

</html>
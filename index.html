<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- App / PWA feel -->
  <meta name="theme-color" content="#E30613" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#C10511" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.webmanifest"> <!-- optional if you have it -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png"> <!-- optional -->

  <!-- Speed up font load -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <title>Word Circle Game</title>

  <!-- Single stylesheet used by all challenges -->
  <link id="challengeStylesheet" rel="stylesheet" href="challenges/default/styles.css">

  <!-- jsPDF for results export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- FOUC guard -->
  <style>
    html:not(.styles-ready) body {
      visibility: hidden;
    }

    html:not(.styles-ready) #loadingScreen {
      visibility: visible;
      display: flex !important;
    }

    #loadingScreen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      z-index: 10000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .loading-content {
      text-align: center;
      color: #d33;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(227, 6, 19, .25);
      border-top: 4px solid #E30613;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <script>
    // unhide once the stylesheet loads
    (function () {
      const link = document.getElementById('challengeStylesheet');
      if (link) link.addEventListener('load', () => document.documentElement.classList.add('styles-ready'));
      // safety hatch in case onload is missed (e.g. cached)
      window.addEventListener('DOMContentLoaded', () => {
        if (!link || link.sheet) document.documentElement.classList.add('styles-ready');
      });
    })();
  </script>
</head>

<body>
  <!-- 3-2-1 countdown -->
  <div id="countdownOverlay" style="display:none;">
    <div id="countdownNumber">3</div>
  </div>

  <!-- Optional admin (hidden) -->
  <div id="adminPanel" style="display:none; margin:16px 0;"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen" style="display:flex;">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>Loading Game...</h3>
    </div>
  </div>

  <!-- Welcome Screen -->
  <div id="welcomeScreen" class="welcome-screen" style="display:none;">
    <div class="welcome-container">
      <div class="welcome-header">
        <div class="welcome-logo" id="welcomeLogo"></div>
        <h1 class="welcome-title" id="gameTitle"></h1>
        <p class="welcome-subtitle" id="gameSubtitle"></p>
      </div>

      <div class="welcome-content">
        <div class="game-rules">
          <h3>üéØ How to Play</h3>

          <div class="rules-grid">
            <div class="rule-item">
              <h4>üèÜ The Challenge</h4>
              <p>Answer business-related questions for each letter A‚ÄìZ. Each letter has a specific definition to
                complete.</p>
            </div>
            <div class="rule-item">
              <h4>‚è∞ Time Pressure</h4>
              <p>You have <span id="welcomeTimeLimit"></span> to complete all 26 questions. Quick thinking and business
                knowledge are key!</p>
            </div>
            <div class="rule-item">
              <h4>üéÆ Controls</h4>
              <p><strong>Answer:</strong> Type and press Enter<br><strong>Pass:</strong> Skip to next
                question<br><strong>Hint:</strong> First letter + length (<span id="welcomeMaxHints"></span> max)</p>
            </div>
            <div class="rule-item">
              <h4>üß† Smart Matching</h4>
              <p>The system accepts similar answers and provides helpful hints when you're close.</p>
            </div>
          </div>

          <div class="scoring-table">
            <h4>üìä Scoring System</h4>
            <div class="scoring-row"><span>Correct Answer</span><span id="correctPoints" class="correct-score"></span>
            </div>
            <div class="scoring-row"><span>Incorrect Answer</span><span id="incorrectPoints"
                class="incorrect-score"></span></div>
            <div class="scoring-row"><span>Pass (Skip)</span><span id="pasapalabraPoints" class="warning-score"></span>
            </div>
            <div class="scoring-row">
              <span>Time Bonus (<span id="timeBonusThreshold"></span>+ correct)</span>
              <span id="maxTimeBonus" class="correct-score"></span>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="warning" onclick="startPreview()">üëÅÔ∏è Preview Questions</button>
          <button onclick="startGame()">üöÄ Start Challenge</button>
        </div>

        <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
          <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
            <a href="https://github.com/susavg/alphabetGame" target="_blank" rel="noopener noreferrer" style="color: #666; text-decoration: none; font-size: 0.9rem; opacity: 0.7; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 0.3rem;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
              <svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
              </svg>
              GitHub
            </a>
            <span style="color: #ccc;">|</span>
            <a href="/admin.html" style="color: #666; text-decoration: none; font-size: 0.9rem; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
              üîí Admin Panel
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Container -->
  <div id="gameContainer" class="game-container" style="display:none;">
    <header class="compact-header">
      <div class="header-top">
        <button class="back-home" type="button" title="Back to home" onclick="game.backToWelcome()">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>
        <h1 id="gameHeaderTitle"></h1>
        <span class="header-spacer" aria-hidden="true"></span>
      </div>

      <div class="header-stats">
        <div class="stat mini"><span>CORRECT</span><strong id="correctCount">0</strong></div>
        <div class="stat mini"><span>WRONG</span><strong id="incorrectCount">0</strong></div>
        <div class="stat mini"><span>POINTS</span><strong id="pointsCount">0</strong></div>
        <div class="stat mini"><span>HINTS</span><strong class="hints-left">0</strong></div>
        <div id="timer" class="timer-mini">00:00</div>
      </div>
    </header>

    
    <!-- Rosco -->
    <div class="playfield">
      <div class="rosco-container">
        <div class="rosco" id="rosco"></div>
        <div class="current-letter" id="currentLetterDisplay"></div>
        <div class="center-image"><div id="centerLogo"></div></div>
      </div>
    </div>

    <!-- Sticky action bar with question + input + buttons (all together) -->
    <div id="actionBar" class="actionbar">
      <div id="hintToast" class="hint-toast" aria-live="polite"></div>

      <div class="game-info in-bar" hidden>
        <div class="question-row">
          <p id="definition"></p>
          <button id="hintIcon" class="hint-icon" onclick="game.showHint()" title="Hint" aria-label="Hint">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M9 18h6m-5 2h4M12 2a7 7 0 00-4 12v2h8v-2A7 7 0 0012 2z" fill="none" stroke="currentColor"
                stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>
        <div id="fuzzyHint" class="fuzzy-hint" style="display:none;">
          ü§î Close! Try a similar word or check your spelling.
        </div>
      </div>

      <!-- One-row chat-style composer -->
      <div class="answer-row">
        <form id="answerForm" class="answer-form" onsubmit="return false;">
          <input
            type="text"
            id="answer"
            placeholder="Type your answer here..."
            autocomplete="off"
            autocapitalize="none"
            autocorrect="off"
            spellcheck="false"
            enterkeyhint="done"
            inputmode="text"
          />

          <button id="btnSubmit" class="btn-ctl with-ico" type="button" aria-label="Submit">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z" />
            </svg>
            <span class="lbl">SUBMIT</span>
          </button>

          <button id="btnPass" class="btn-ctl btn-pass with-ico" type="button" aria-label="Pass">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M8 5v14l11-7zM5 5h2v14H5z" />
            </svg>
            <span class="lbl">PASS</span>
          </button>
        </form>
      </div>
    </div>

    <div id="finalScore"></div>

    <div style="text-align:center; margin-top: 12px;">
      <button id="viewResults" onclick="game.showResults()" style="display:none;">üìä View detailed results</button>
    </div>

    <div id="results" style="display:none;"></div>
  </div>

  <!-- Scripts -->
  <script src="gameUtils.js"></script>
  <script src="wordCircleGame.js"></script>
  <script>
    function runCountdown(cb) {
      const o = document.getElementById('countdownOverlay');
      const n = document.getElementById('countdownNumber');
      let v = 3; n.textContent = v; o.classList.add('show');
      const t = setInterval(() => {
        v--;
        if (v <= 0) { clearInterval(t); o.classList.remove('show'); cb(); }
        else { n.textContent = v; }
      }, 1000);
    }

    function updateModePill(isPreview) {
      const pill = document.getElementById('modePill');
      if (pill) pill.hidden = !isPreview;
    }

    function startGame() {
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      const gi = document.querySelector('#actionBar .game-info');
      if (gi) gi.hidden = true;                    // hide during countdown
      const def = document.querySelector('#actionBar #definition');
      if (def) def.textContent = '';               // triggers the "Loading game‚Ä¶" placeholder
      runCountdown(() => game.newGame());
    }

    function startPreview() {
      document.body.classList.add('preview-mode');
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      const gi = document.querySelector('#actionBar .game-info');
      if (gi) gi.hidden = true;
      const def = document.querySelector('#actionBar #definition');
      if (def) def.textContent = '';
      runCountdown(() => game.startPreview());
    }

    (function wrapBackToWelcome() {
      const original = WordCircleGame && WordCircleGame.prototype.backToWelcome;
      if (typeof original === 'function') {
        WordCircleGame.prototype.backToWelcome = function () {
          original.call(this);
          updateModePill(false);
        };
      }
    })();

    window.addEventListener('load', async () => {
    try {
      await game.init();

      // Always start at the very top (don‚Äôt autofocus anything that might scroll into view)
      window.scrollTo(0, 0);
      document.body.scrollTop = 0; // iOS/Safari fallback
    } catch (err) {
      console.error('Failed to initialize game:', err);
      document.getElementById('loadingScreen').innerHTML =
        '<div class="loading-content"><h3 style="color: red;">Error loading game. Please check console.</h3></div>';
    }
  });
  </script>
  <script>
    function setHeaderHeightVar(){
      const el = document.querySelector('.compact-header');
      if(!el) return;
      const h = el.offsetHeight;                 // includes safe-area padding
      document.documentElement.style.setProperty('--app-header-height', h + 'px');
    }
  
    // run on load and when things that can change height happen
    window.addEventListener('load', setHeaderHeightVar);
    window.addEventListener('resize', setHeaderHeightVar);
    window.addEventListener('orientationchange', setHeaderHeightVar);
    if (window.visualViewport) {
      visualViewport.addEventListener('resize', setHeaderHeightVar);
    }
    // if fonts load late
    document.fonts?.ready?.then(setHeaderHeightVar);
  </script>

  <script>
    // ‚Äî‚Äî‚Äî zoom lock helper ‚Äî‚Äî‚Äî
    (function () {
      const vp = document.querySelector('meta[name="viewport"]');
      const DEFAULT = 'width=device-width, initial-scale=1.0';
      const LOCKED = DEFAULT + ', maximum-scale=1, user-scalable=no';
      function setViewport(lock) { if (vp) vp.setAttribute('content', lock ? LOCKED : DEFAULT); }
      window.__lockZoom = setViewport;

      // Prevent iOS "double-tap to zoom"
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) { e.preventDefault(); }
        lastTouchEnd = now;
      }, { passive: false });
    })();

    // Lock while playing / previewing; restore on home
    (function patchGameZoom() {
      const proto = WordCircleGame && WordCircleGame.prototype;
      if (!proto) return;

      const _startPreview = proto.startPreview;
      proto.startPreview = function () {
        window.__lockZoom?.(true);
        return _startPreview.call(this);
      };

      const _newGame = proto.newGame;
      proto.newGame = function () {
        window.__lockZoom?.(true);
        return _newGame.call(this);
      };

      const _back = proto.backToWelcome;
      proto.backToWelcome = function () {
        const r = _back.call(this);
        window.__lockZoom?.(false);
        return r;
      };
    })();
  </script>

</body>

</html>
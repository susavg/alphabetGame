<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Word Circle Game</title>

  <!-- Theme/Challenge stylesheet is set at runtime by wordCircleGame.js -->
  <link id="challengeStylesheet" rel="stylesheet" href="">

  <!-- jsPDF for results export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- FOUC guard: keep only the loading screen visible until CSS is ready -->
  <style>
    html:not(.styles-ready) body { visibility: hidden; }
    html:not(.styles-ready) #loadingScreen { visibility: visible; display:flex!important; }
    #loadingScreen {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: #f5f5f5; z-index: 10000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .loading-content { text-align:center; color:#d33; }
    .spinner{ width:50px; height:50px; border:4px solid rgba(227,6,19,.25); border-top:4px solid #E30613;
      border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
  <script>
    (function () {
      const link = document.getElementById('challengeStylesheet');
      if (link) link.addEventListener('load', () => document.documentElement.classList.add('styles-ready'));
      window.addEventListener('DOMContentLoaded', () => {
        if (!link || link.sheet) document.documentElement.classList.add('styles-ready');
      });
    })();
  </script>

  <!-- Compact layout CSS (adds on top of your challenge styles) -->
  <style>
    /* Header bar */
    .compact-header { border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,.12); margin-bottom: 18px; }
    .header-top{
        display:flex; align-items:center; justify-content:space-between;
        background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 80%, #000));
        color:#fff; padding:10px 14px;
    }
    .compact-header h1 { margin:0; font-size:1.1rem; font-weight:700; letter-spacing:.02em; }
    .back-home{
      display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; border-radius:50%; border:0; padding:0; min-width:auto;
      background:rgba(255,255,255,.12); color:#fff; cursor:pointer;
    }
    .back-home:hover{ background:rgba(255,255,255,.18); }

    .mode-pill{
      background: linear-gradient(135deg, #ff9a1f, #e67300);
      color:#fff; font-weight:800; font-size:.8rem; padding:6px 10px; border-radius:999px;
    }

    /* One-row scoreboard */
    .header-stats{
      display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:6px;
      background: #f6f7f8; padding:10px 12px; border-bottom:1px solid #e5e5e5;
    }
    .stat.mini{
      background:#fff; border:1px solid #e9e9e9; border-radius:10px;
      padding:8px 10px; text-align:center;
    }
    .stat.mini span{ display:block; font-size:.68rem; color:#667; letter-spacing:.06em; }
    .stat.mini strong{ font-size:1.1rem; color:#0f2233; }

    #timer.timer-mini{
      align-self:stretch; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--accent-color, #3498db) 0%, #2663a3 100%);
      color:#fff; font-weight:800; border-radius:10px; border:3px solid rgba(255,255,255,.25);
    }
    #timer.timer-mini.timer-urgent{
      background: linear-gradient(135deg, #FF4444 0%, #CC0000 100%) !important;
      animation: pulse-urgent 1s infinite;
    }
    @keyframes pulse-urgent {
      0%,100% { transform: none; box-shadow: 0 4px 16px rgba(0,0,0,.12); }
      50% { transform: scale(1.03); box-shadow: 0 10px 28px rgba(255,0,0,.35); }
    }

    /* Question card + hint icon (no overlap) */
    .game-info{ padding:16px 16px 12px; position:relative; }
    .question-row{ display:flex; align-items:flex-start; gap:10px; }
    .question-row p{ flex:1; margin:0; }
    .hint-icon{
      flex:0 0 auto; width:36px; height:36px; border-radius:10px; border:1px solid #e6e6e6;
      background:#fff; color:#666; padding:0; min-width:auto; box-shadow: 0 2px 8px rgba(0,0,0,.08);
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .hint-icon:hover{ background:#fafafa; }

    /* Two primary buttons on one row */
    .btn-row{ display:flex; gap:12px; margin:14px 0 6px; }
    .btn-row button{ flex:1; min-width:0; border-radius:999px; }

    /* Hide any legacy in-game rules/scoring UI if left in DOM */
    .conditions-bar, .cond-toggle, #condOverlay, .challenge-badge, .game-stats,
    #btnHint, #btnNewGame { display:none !important; }

    /* Countdown overlay */
    #countdownOverlay{
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center; z-index: 100000; backdrop-filter: blur(2px);
    }
    #countdownOverlay.show{ display:flex; }
    #countdownNumber{
      font: 900 120px/1 system-ui, -apple-system, 'Open Sans', sans-serif;
      color: #fff; text-shadow: 0 10px 40px rgba(0,0,0,.35); animation: pop 1s ease-out infinite;
    }
    @keyframes pop{ 0%{ transform: scale(.6); opacity:.2;} 50%{ transform: scale(1.1); opacity:1;} 100%{ transform: scale(1); opacity:.85;} }

    /* Mobile tweaks */
    @media (max-width: 480px){
      .compact-header { border-radius: 12px; }
      .compact-header h1 { font-size: .98rem; }
      .header-stats{ gap:4px; padding:8px; }
      .stat.mini{ padding:6px 6px; border-radius:8px; }
      .stat.mini strong{ font-size:1rem; }
      .back-home{ width:30px; height:30px; }
      .hint-icon{ width:32px; height:32px; border-radius:8px; }
      .btn-row{ gap:10px; }
    }
  </style>
</head>

<body>
  <!-- 3-2-1 countdown -->
  <div id="countdownOverlay" style="display:none;">
    <div id="countdownNumber">3</div>
  </div>

  <!-- Optional admin (kept hidden) -->
  <div id="adminPanel" style="display:none; margin:16px 0;"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen" style="display:flex;">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>Loading Game...</h3>
    </div>
  </div>

  <!-- Welcome Screen (rules & scoring live here only) -->
  <div id="welcomeScreen" class="welcome-screen" style="display:none;">
    <div class="welcome-container">
      <div class="welcome-header">
        <div class="welcome-logo" id="welcomeLogo"></div>
        <h1 class="welcome-title" id="gameTitle"></h1>
        <p class="welcome-subtitle" id="gameSubtitle"></p>
      </div>

      <div class="welcome-content">
        <div class="game-rules">
          <h3>üéØ How to Play</h3>
          <div class="rules-grid">
            <div class="rule-item">
              <h4>üèÜ The Challenge</h4>
              <p>Answer business-related questions for each letter A‚ÄìZ. Each letter has a specific definition to complete.</p>
            </div>
            <div class="rule-item">
              <h4>‚è∞ Time Pressure</h4>
              <p>You have <span id="welcomeTimeLimit"></span> to complete all 26 questions. Quick thinking and business knowledge are key!</p>
            </div>
            <div class="rule-item">
              <h4>üéÆ Controls</h4>
              <p><strong>Answer:</strong> Type and press Enter<br><strong>Pass:</strong> Skip to next question<br><strong>Hint:</strong> First letter + length (<span id="welcomeMaxHints"></span> max)</p>
            </div>
            <div class="rule-item">
              <h4>üß† Smart Matching</h4>
              <p>The system accepts similar answers and provides helpful hints when you're close.</p>
            </div>
          </div>

          <div class="scoring-table">
            <h4>üìä Scoring System</h4>
            <div class="scoring-row"><span>Correct Answer</span><span id="correctPoints" class="correct-score"></span></div>
            <div class="scoring-row"><span>Incorrect Answer</span><span id="incorrectPoints" class="incorrect-score"></span></div>
            <div class="scoring-row"><span>Pass (Skip)</span><span id="pasapalabraPoints" class="warning-score"></span></div>
            <div class="scoring-row">
              <span>Time Bonus (<span id="timeBonusThreshold"></span>+ correct)</span>
              <span id="maxTimeBonus" class="correct-score"></span>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="warning" onclick="startPreview()">üëÅÔ∏è Preview Questions</button>
          <button onclick="startGame()">üöÄ Start Challenge</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Container (hidden until Start/Preview) -->
  <div id="gameContainer" class="game-container" style="display:none;">
    <!-- Compact header -->
    <header class="compact-header">
      <div class="header-top">
        <button class="back-home" type="button" title="Back to home" onclick="game.backToWelcome()">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <h1 id="gameHeaderTitle"></h1>
        <span class="header-spacer" aria-hidden="true"></span>
      </div>

      <div class="header-stats">
        <div class="stat mini"><span>CORRECT</span><strong id="correctCount">0</strong></div>
        <div class="stat mini"><span>WRONG</span><strong id="incorrectCount">0</strong></div>
        <div class="stat mini"><span>POINTS</span><strong id="pointsCount">0</strong></div>
        <div class="stat mini"><span>HINTS</span><strong class="hints-left">0</strong></div>
        <div id="timer" class="timer-mini">00:00</div>
      </div>
    </header>

    <!-- Rosco (Letter Circle) -->
    <div class="rosco-container">
      <div class="rosco" id="rosco"></div>
      <div class="current-letter" id="currentLetterDisplay"></div>
      <div class="center-image"><div id="centerLogo"></div></div>
    </div>

    <!-- Question block with icon-only hint -->
    <div class="game-info">
      <div class="question-row">
        <p id="definition">Loading game...</p>
        <button id="hintIcon" class="hint-icon" onclick="game.showHint()" title="Hint" aria-label="Hint">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M9 18h6m-5 2h4M12 2a7 7 0 00-4 12v2h8v-2A7 7 0 0012 2z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="fuzzyHint" class="fuzzy-hint" style="display:none;">
        ü§î Close! Try a similar word or check your spelling.
      </div>
    </div>

    <!-- Input -->
    <div class="input-container">
      <input type="text" id="answer" placeholder="Type your answer here..." autocomplete="off" />
    </div>

    <!-- Two buttons on one row -->
    <div class="btn-row">
        <button id="btnSubmit" class="with-ico" onclick="game.checkAnswer()">
          <!-- check icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/>
          </svg>
          SUBMIT
        </button>
      
        <button id="btnPass" class="btn-pass with-ico" onclick="game.pasapalabra()">
          <!-- skip/play-next icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M8 5v14l11-7zM5 5h2v14H5z"/>
          </svg>
          PASS
        </button>
    </div>

    <!-- Final Score -->
    <div id="finalScore"></div>

    <div style="text-align:center; margin-top: 12px;">
      <button id="viewResults" onclick="game.showResults()" style="display:none;">üìä View detailed results</button>
    </div>

    <!-- Results Panel -->
    <div id="results" style="display:none;"></div>
  </div>

  <!-- Scripts -->
  <script src="gameUtils.js"></script>
  <script src="wordCircleGame.js"></script>
  <script>
    function runCountdown(cb){
      const o = document.getElementById('countdownOverlay');
      const n = document.getElementById('countdownNumber');
      let v = 3; n.textContent = v; o.classList.add('show');
      const t = setInterval(() => {
        v--;
        if (v <= 0) { clearInterval(t); o.classList.remove('show'); cb(); }
        else { n.textContent = v; }
      }, 1000);
    }

    // Small pill that says "PREVIEW"
    function updateModePill(isPreview){
      const pill = document.getElementById('modePill');
      if (pill) pill.hidden = !isPreview;
    }

    function startGame(){
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      updateModePill(false);
      runCountdown(() => game.newGame());
    }

    function startPreview(){
      document.body.classList.add('preview-mode');
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      updateModePill(true);
      runCountdown(() => game.startPreview());
    }

    // Ensure back-home also hides the preview pill
    (function wrapBackToWelcome(){
      const original = WordCircleGame && WordCircleGame.prototype.backToWelcome;
      if (typeof original === 'function'){
        WordCircleGame.prototype.backToWelcome = function(){
          original.call(this);
          updateModePill(false);
        };
      }
    })();

    // App init
    window.addEventListener('load', async () => {
      try {
        await game.init();
        // Move focus to Start button for quick enter/space on desktop
        setTimeout(() => {
          const startBtn = document.querySelector('button[onclick="startGame()"]');
          if (startBtn) startBtn.focus();
        }, 100);
      } catch (err) {
        console.error('Failed to initialize game:', err);
        document.getElementById('loadingScreen').innerHTML =
          '<div class="loading-content"><h3 style="color: red;">Error loading game. Please check console.</h3></div>';
      }
    });
  </script>
</body>
</html>